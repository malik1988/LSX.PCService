# LSX.PCService
流水线上位机服务程序

## 系统逻辑
1. 导入总捡单
1. 导入质检单（item对应的物料是否需要质检）
1. 总捡单中 栈板号对应的item编码不唯一则判定为散料，需要流水线处理，否则不需要整托不需要流水线。
1. 总捡单中数据按照车次分组开始，每次只能开始一个车次的订单。
1. 
1. 流水线行进触发相机拍照识别并获取任务单号（09码、数量）
1. 根据09码不同分配到指定道口


1. 扫描栈板号预分派

1. 一个09码可能对应多个LPN，一个LPN就是一个灯，没有托盘的概念
1. 回传以LPN为单位回传
1. 绑定LPN的时候提示质检信息
1. 质检信息是09码对应表格提供的

1. 箱号唯一
根据箱号合并数量
2. 09码对应LPN，根据09码合并道口
一个09码对应多个箱号，合并分拣到一个道口


## 可能问题
1. 箱上 摆放面可能会出现扫不到
1. 箱子上条码有多个，识别箱号可能会出现问题


## 数据字段

1. 箱号
1. 栈板号
1. 车牌
1. 发货单号
1. 到货地点 松山湖34号的 质检信息必须 导入，其他可用现成的
1. 物料号（item）   09+item+收据号
1. 收据号 
1. 检验标志
1. 数量 （累计总数用）
1. 原产国


## AGV转运
1. 四个目的地 ，目的地=到货地址+质检标志
2. 起始地 ，扫描地上的库位号（跟LPN能区分）


## 按灯
1. 2个分拣口的灯是独立的
1. 1个分拣口只会有一个灯亮
1. 灯必须手动按灭才能点亮下

## 回传
1. LPN维度上传
1. 支持重传
1. 单独线程上传

## 报表数量不符
1. 如果订单没全部完成，上传CWMS提示订单未完成，CWMS提供接口
1. 手动关单界面
	1. 人工扫描订单
	1. 人工、自动扫描同时进行
	1. 手动结束订单



## 数据库模型
- TableOrgRecv 原始导入数据表 09码绑定



## 逻辑模型

- 输入箱号->触发



## 与流水线通道控制消息协议


   | 功能码 | 通道号  | 说明                       |
   | ------ | ------- | -------------------------- |
   | 0x10   | 1，2，3 | PC向流水线发送目标通道     |
   | 0x20   | 1,2,3   | 流水线向PC发送通道货物到达 |
   | 0x30   | 1,2,3   | 流水线向PC发送通道货物取走 |




## 系统流程

1. 扫描发货单号（从对接系统获取该单号对应的所有物料数据），该过程重复多次直到一车发货单号全部扫描完成。
    - 分析原始数据，得到包含09码、质检信息、是否整托的 数据表
	- 开始已扫描的所有发货单号(将发货单号存放在一个“发货任务表”中，之后所有的任务都以这个表数据和原始数据联合查询)

2. 扫描栈板号(托盘号)
- 逻辑：
    1. 将栈板号存放入数据库（栈板任务表），栈板号作为新的栈板任务单号，没扫描一次添加一个栈板任务。
    1. 栈板任务 + 发货任务表 + 原始数据表 =>正在进行的订单总表（临时表，view）

	- 判定是否整托
    	- 是整托
    	- 不是整托
1. 扫描箱号（两种方式：扫描枪+流水线相机）
    1. 如果是整托订单，直接提示质检信息（进入绑定流程）
    2. 如果不是整托订单，流水线操作
    3. 

1. 流水线操作：
   1. 扫描箱号，如果箱号属于当前订单总表（订单总表中存在），流水线分配道口（正常道口）
   2. 不属于当前订单总表，流水线分配异常道口；
   3. 当前订单按照09码创建 09-灯（是否集齐整托）表，09码相同的合并关联到一个灯，并创建一个虚拟托盘ID（用于绑定库位）。
   
   4. 如果当前09码集齐整托（当前09码所有订单已经完成，人为按灯发送集齐消息）则释放该09码关联的灯ID
2. 托盘-库位绑定
   1. 托盘ID创建时系统从库位表中分配一个库位ID，并绑定形成 托盘-库位表。
   2. 托盘-库位表中存放目标库位属性（表示目标库位所在位置，2楼，3楼，质检等），该属性从任务订单中分析获取。
   3. 创建托盘ID时分配的灯必须放在库位ID所在位置。（灯与库位ID对应）
   4. 待发送表示等待发送给AGV调度（待转运）
3. AGV转运
   1. 扫描库位ID
   2. 如果库位ID在托盘-库位绑定表中存在，且状态为待发送，则视为该库位ID为系统生成的。
   3. 如果库位ID不在“托盘-库位绑定表中”则表示该托盘货物由操作人员手动指定的，则需要扫描目标库位。
   4. AGV调度接口：
	  - 流水线系统发送：
		- 起点库位
		- 终点库位
	  - 流水线系统接收：
	    - 订单发送状态（成功、失败）
		- 发送成功的订单编号
		

## 构建程序框架，数据服务外包给第三方处理。

## 一个09码对应只有一个箱号的 全部合并放在一个栈板上，分配一个灯（虚拟成相同的09码）

## 
